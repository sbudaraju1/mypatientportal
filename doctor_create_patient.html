<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Create Patient</title>
  <link rel="stylesheet" href="/css/styles.css">
  <script src="/js/client.js"></script>
  <style>
    #back {
      width: auto;
      padding: 8px 60px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header><h2>New Patient Account</h2>
		<a href="/doctor_dashboard.html">
			<button id="back">Back</button></header>
		</a>
	</header>
    <form id="createPatientForm">
      <label>Patient Name</label>
      <input type="text" name="name" required>
      
      <label>Username</label>
      <input type="text" name="username" required>
      
      <label>Password</label>
      <input type="password" name="password" required>
      
      <label>Email</label>
      <input type="email" name="email">
      
      <label>Date of Birth</label>
      <input type="date" name="dob">
      
      <label>Phone</label>
      <input type="tel" name="phone">
      
      <button type="submit">Create Patient</button>
      <p id="err" class="err"></p>
      <p id="success" style="color: green;"></p>
    </form>
  </div>
<script>
// Wait for both DOM and client.js to load
window.addEventListener('DOMContentLoaded', init);

async function init() {
  const s = await checkSession();
  if (!s.loggedIn || s.user.role !== "doctor") {
    return window.location = "/physician_login.html";
  }
  
  // Set up back button
  document.getElementById("back").addEventListener("click", () => {
    window.location = "/doctor_dashboard.html";
  });
  
  // Set up form submission
  document.getElementById("createPatientForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    
    // Clear previous messages
    document.getElementById("err").textContent = "";
    document.getElementById("success").textContent = "";
    
    const f = e.target;
    const payload = {
      name: f.name.value,
      username: f.username.value,
      password: f.password.value,
      email: f.email.value || null,
      dob: f.dob.value || null,
      phone: f.phone.value || null,
      role: "patient"
    };
    
    console.log("Creating patient:", payload);
    
    try {
      const res = await fetch("/api/doctor/patient", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
      });
      
      const j = await res.json();
      
      console.log("Response status:", res.status);
      console.log("Response data:", j);
      
      if (j.ok || res.ok || res.status === 200) {
        document.getElementById("success").textContent = "âœ“ Patient created successfully!";
        document.getElementById("success").style.fontWeight = "bold";
        document.getElementById("success").style.fontSize = "16px";
        // Clear form
        f.reset();
        // Redirect after 2 seconds so user can see the message
        setTimeout(() => {
          window.location = "/doctor_dashboard.html";
        }, 2000);
      } else {
        document.getElementById("err").textContent = j.error || "Error creating patient";
        console.error("Error creating patient:", j);
      }
    } catch (error) {
      console.error("Error:", error);
      document.getElementById("err").textContent = "Network error. Please try again.";
    }
  });
}

</script>
</body>
</html>