<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>My Profile</title>
  <link rel="stylesheet" href="/css/styles.css">
  <script src="/js/client.js"></script>
  <style>
    body {
      background-image: url('/blue_background.jpg');
      background-size: cover;
      background-position: center;
    }
    #back {
      width: auto;
      padding: 8px 30px;
    }
    .form-section {
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .form-section h3 {
      margin-top: 0;
      color: #333;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 10px;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }
    .form-row label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .form-row input, .form-row textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .full-width {
      grid-column: 1 / -1;
    }
    #success {
      color: green;
      font-weight: bold;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h2>My Profile</h2>
      <a href="/patient_home.html">
        <button id="back">Back to Home</button>
      </a>
    </header>
    
    <form id="profileForm">
      <div class="form-section">
        <h3>Personal Information</h3>
        <div class="form-row">
          <div>
            <label>Full Name *</label>
            <input type="text" name="name" required>
          </div>
          <div>
            <label>Date of Birth</label>
            <input type="date" name="birthday">
          </div>
        </div>
        <div class="form-row">
          <div>
            <label>Email</label>
            <input type="email" name="email">
          </div>
          <div>
            <label>Phone</label>
            <input type="tel" name="phone" placeholder="(123) 456-7890">
          </div>
        </div>
        <div class="form-row">
          <div class="full-width">
            <label>Address</label>
            <input type="text" name="address" placeholder="Street, City, State, ZIP">
          </div>
        </div>
      </div>

      <div class="form-section">
        <h3>Emergency Contact</h3>
        <div class="form-row">
          <div>
            <label>Contact Name</label>
            <input type="text" name="emergency_contact" placeholder="Full Name">
          </div>
          <div>
            <label>Contact Phone</label>
            <input type="tel" name="emergency_phone" placeholder="(123) 456-7890">
          </div>
        </div>
      </div>

      <div class="form-section">
        <h3>Medical Information</h3>
        <div class="form-row">
		  <div>
            <label>Prescriptions</label>
            <input type="text" name="prescriptions">
          </div><br>
          <div>
            <label>Blood Type</label>
            <input type="text" name="blood_type" placeholder="e.g., A+, O-, B+">
          </div>
          <div class="full-width">
            <label>Allergies</label>
            <textarea name="allergies" rows="3" placeholder="List any allergies (medications, food, etc.)"></textarea>
          </div>
        </div>
      </div>

      <button type="submit">Save Changes</button>
      <p id="err" class="err"></p>
      <p id="success"></p>
    </form>
  </div>

<script>
window.addEventListener('DOMContentLoaded', init);

async function init() {
  try {
    console.log("Profile page init started");
    
    const s = await checkSession();
    if (!s.loggedIn || s.user.role !== "patient") {
      return window.location = "/login_page.html";
    }
    
    // Load profile data
    console.log("Fetching profile...");
    const data = await api("/api/patient/profile");
    console.log("Profile data:", data);
    
    if (data.profile) {
      const p = data.profile;
      const form = document.getElementById("profileForm");
      
      // Populate form fields
      form.name.value = p.name || "";
      form.birthday.value = p.birthday || "";
      form.email.value = p.email || "";
      form.phone.value = p.phone || "";
      form.address.value = p.address || "";
      form.emergency_contact.value = p.emergency_contact || "";
      form.emergency_phone.value = p.emergency_phone || "";
      form.blood_type.value = p.blood_type || "";
      form.allergies.value = p.allergies || "";
    }
    
    // Handle form submission
    document.getElementById("profileForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      
      // Clear previous messages
      document.getElementById("err").textContent = "";
      document.getElementById("success").textContent = "";
      
      const f = e.target;
      const payload = {
        name: f.name.value,
        birthday: f.birthday.value,
        email: f.email.value,
        phone: f.phone.value,
        address: f.address.value,
        emergency_contact: f.emergency_contact.value,
        emergency_phone: f.emergency_phone.value,
        blood_type: f.blood_type.value,
        allergies: f.allergies.value
      };
      
      console.log("Updating profile:", payload);
      
      try {
        const res = await fetch("/api/patient/profile", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        
        const result = await res.json();
        
        if (result.ok) {
          document.getElementById("success").textContent = "âœ“ Profile updated successfully!";
          // Scroll to top to see success message
          window.scrollTo({ top: 0, behavior: 'smooth' });
        } else {
          document.getElementById("err").textContent = result.error || "Failed to update profile";
        }
      } catch (error) {
        console.error("Error updating profile:", error);
        document.getElementById("err").textContent = "Network error. Please try again.";
      }
    });
    
  } catch (error) {
    console.error("Profile page error:", error);
  }
}
</script>
</body>
</html>