<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Patient Home</title>
  <link rel="stylesheet" href="/css/styles.css">
  <script src="/js/client.js"></script>
  <style>
	body {
  		background-image: url('/blue_background.jpg');
		background-size: cover;
		background-position: center;
	}
	.btn-export, .btn-view {
		background-color: #FF9800;
		color: white;
		padding: 5px 10px;
		border: none;
		border-radius: 3px;
		cursor: pointer;
		font-size: 12px;
		margin-right: 5px;
	}
	.btn-view {
		background-color: #2196F3;
	}
	.btn-export:hover, .btn-view:hover {
		opacity: 0.8;
	}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h2 id="welcome">Patient Portal</h2>
      <div>
	    <a href="/patient_profile.html">
			<button>My Profile</button>
		</a>
		<a href="/patient_documents.html">
			<button>My Documents</button>
		</a>
        <a href="/logout">
			<button>Logout</button>
		</a>
      </div>
    </header>
    <section>
      <h3>Your Health Reports</h3>
      <table class="table" id="reportsTable">
        <thead><tr><th>Date</th><th>Diagnosis</th><th>Doctor</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </div>
<script>
window.addEventListener('DOMContentLoaded', init);

async function init() {
  try {
    console.log("Patient home init started");
    
    const session = await checkSession();
    console.log("Session:", session);
    
    if (!session.loggedIn || session.user.role !== "patient") {
      window.location = "/login_page.html";
      return;
    }
    
    // Update welcome message
    document.getElementById("welcome").textContent = `Welcome, ${session.user.name || session.user.username}`;
    
    // Fetch patient reports
    console.log("Fetching patient reports...");
    const data = await api("/api/patient/reports");
    console.log("Reports data:", data);
    
    const tbody = document.querySelector("#reportsTable tbody");
    tbody.innerHTML = "";
    
    if (data.reports && data.reports.length > 0) {
      data.reports.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.date || ""}</td>
          <td>${r.diagnosis || ""}</td>
          <td>${r.doctor_name || r.doctor_username || ""}</td>
          <td>
            <button class="btn-view" data-id="${r.id}">View Full Report</button>
            <button class="btn-export" onclick="exportPDF(${r.id})">Export PDF</button>
          </td>`;
        tbody.appendChild(tr);
      });
      
      // Add event listeners for view buttons AFTER creating them
      document.querySelectorAll(".btn-view").forEach(b =>
        b.addEventListener("click", e => {
          const reportId = e.target.dataset.id;
          window.location.href = `/report_view.html?id=${reportId}`;
        })
      );
      
      console.log(`âœ“ Loaded ${data.reports.length} reports for patient`);
    } else {
      console.log("No reports found for this patient");
      tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No reports yet</td></tr>';
    }
    
  } catch (error) {
    console.error("Patient home error:", error);
  }
}

function exportPDF(reportId) {
  console.log("Exporting report", reportId, "as PDF");
  window.location.href = `/api/report/pdf/${reportId}`;
}
</script>
</body>

</html>

