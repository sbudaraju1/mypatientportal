<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Upload Patient Document</title>
  <link rel="stylesheet" href="/css/styles.css">
  <script src="/js/client.js"></script>
  <style>
    #back {
      width: auto;
      padding: 8px 16px;
    }
    .upload-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
    }
    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
      margin: 10px 0;
    }
    .file-input-wrapper input[type=file] {
      font-size: 100px;
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      cursor: pointer;
    }
    .file-input-wrapper .btn-file-input {
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      border-radius: 4px;
      display: inline-block;
      cursor: pointer;
    }
    .file-name {
      margin-left: 10px;
      font-style: italic;
      color: #666;
    }
    .visibility-options {
      margin: 15px 0;
    }
    .visibility-options label {
      display: block;
      margin: 10px 0;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
    }
    .visibility-options input[type="radio"] {
      width: auto;
      margin-right: 10px;
    }
    .visibility-options label:hover {
      background-color: #f5f5f5;
    }
    .visibility-options input[type="radio"]:checked + span {
      font-weight: bold;
    }
    #success {
      color: green;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h2>Upload Patient Document</h2>
      <a href="/doctor_dashboard.html">
        <button id="back">Back to Dashboard</button>
      </a>
    </header>
    
    <div class="upload-section">
      <form id="uploadForm">
        <label>Select Patient *</label>
        <select name="patient_id" required id="patientSelect">
          <option value="">Select a patient...</option>
        </select>
        
        <label>Select File (Images, PDFs, Word docs - Max 10MB) *</label><br>
        <div class="file-input-wrapper">
          <span class="btn-file-input">Choose File</span><br>
          <input type="file" name="document" id="fileInput" accept=".jpg,.jpeg,.png,.pdf,.doc,.docx" required>
        </div>
        <span class="file-name" id="fileName">No file chosen</span><br><br>
        
        <label>Description</label>
        <textarea name="description" rows="3" placeholder="e.g., Lab results from 12/1/2024, X-ray of left arm, etc."></textarea>
        
        <label>Document Visibility *</label>
        <div class="visibility-options">
          <label>
            <input type="radio" name="visibility" value="public" checked>
            <span>Public - Patient and doctors can view</span>
            <small style="display: block; margin-left: 30px; color: #666;">Use for lab results, prescriptions, reports that patient should see</small>
          </label>
          <label>
            <input type="radio" name="visibility" value="private">
            <span>Private - Only doctors can view</span>
            <small style="display: block; margin-left: 30px; color: #666;">Use for sensitive information, internal notes, X-rays, psychiatric evaluations</small>
          </label>
        </div>
        
        <button type="submit">Upload Document</button>
        <p id="err" class="err"></p>
        <p id="success"></p>
      </form>
    </div>
  </div>

<script>
window.addEventListener('DOMContentLoaded', init);

async function init() {
  try {
    console.log("Doctor upload document init started");
    
    const s = await checkSession();
    if (!s.loggedIn || s.user.role !== "doctor") {
      return window.location = "/physician_login.html";
    }
    
    // Load patients
    const patientsRes = await api("/api/doctor/patients");
    const sel = document.getElementById("patientSelect");
    
    if (patientsRes.patients && patientsRes.patients.length > 0) {
      patientsRes.patients.forEach(p => {
        const o = document.createElement("option");
        o.value = p.id;
        o.textContent = `${p.name || p.username} (${p.username})`;
        sel.appendChild(o);
      });
    }
    
    // Show selected file name
    document.getElementById("fileInput").addEventListener("change", (e) => {
      const fileName = e.target.files[0]?.name || "No file chosen";
      document.getElementById("fileName").textContent = fileName;
    });
    
    // Handle file upload
    document.getElementById("uploadForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      
      document.getElementById("err").textContent = "";
      document.getElementById("success").textContent = "";
      
      const formData = new FormData();
      const fileInput = document.getElementById("fileInput");
      const patientId = e.target.patient_id.value;
      const description = e.target.description.value;
      const visibility = e.target.visibility.value;
      
      if (!fileInput.files[0]) {
        document.getElementById("err").textContent = "Please select a file";
        return;
      }
      
      if (!patientId) {
        document.getElementById("err").textContent = "Please select a patient";
        return;
      }
      
      formData.append("document", fileInput.files[0]);
      formData.append("patient_id", patientId);
      formData.append("description", description);
      formData.append("visibility", visibility);
      
      try {
        const res = await fetch("/api/documents/upload", {
          method: "POST",
          body: formData
        });
        
        const result = await res.json();
        
        if (result.ok) {
          const visibilityText = visibility === "public" ? "Patient can view this document" : "Only doctors can view this document";
          document.getElementById("success").textContent = `âœ“ Document uploaded successfully! ${visibilityText}`;
          e.target.reset();
          document.getElementById("fileName").textContent = "No file chosen";
        } else {
          document.getElementById("err").textContent = result.error || "Failed to upload document";
        }
      } catch (error) {
        console.error("Upload error:", error);
        document.getElementById("err").textContent = "Network error. Please try again.";
      }
    });
    
  } catch (error) {
    console.error("Upload page error:", error);
  }
}
</script>
</body>
</html>